<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Hanabi Team Randomizer (R0 vs H-Group)</title>
        <link rel="stylesheet" href="main.css" />
    </head>
    <body>
        <h1>Hanabi Team Randomizer</h1>
        <div class="muted">
            Guarantees <span class="pill">R0</span> and
            <span class="pill">H-group</span> never end up on the same team. If a
            player is neither, they’re treated as
            <span class="pill">flex</span>.
        </div>

        <div class="layout" style="margin-top:16px;">
            <div class="card">
                <div class="row4">
                    <div>
                        <label class="small muted">Player name</label>
                        <input id="nameInput" placeholder="e.g. Alice" />
                    </div>
                    <label class="checkbox" title="R0-only">
                        <input id="r0OnlyToggle" type="checkbox" />
                        <span class="flex">R0</span>
                    </label>
                    <label class="checkbox" title="H-only">
                        <input id="hOnlyToggle" type="checkbox" />
                        <span class="flex">H-group</span>
                    </label>
                </div>

                <div class="row" style="margin-top: 10px">
                    <button id="addBtn">Add player</button>
                    <button id="clearBtn" class="btn-danger">Clear all</button>
                </div>

                <div id="list" class="list"></div>
                <div
                    id="hint"
                    class="small muted"
                    style="margin-top: 8px"
                ></div>

                <div class="row3" style="margin-top: 12px">
                    <div>
                        <label class="small muted">Team size</label>
                        <select id="teamMode">
                            <option value="34">3–4 (default)</option>
                            <option value="3">Only 3</option>
                            <option value="4">Only 4</option>
                        </select>
                    </div>
                    <div>
                        <label class="small muted">Seed (optional)</label>
                        <input id="seed" placeholder="e.g. round-7" />
                    </div>
                    <div>
                        <label class="small muted">Try limit</label>
                        <select id="tries">
                            <option value="5000">5,000</option>
                            <option value="20000" selected>20,000</option>
                            <option value="80000">80,000</option>
                        </select>
                    </div>
                </div>

                <div class="row" style="margin-top: 12px">
                    <button id="run">Generate teams</button>
                    <button id="copy">Copy output</button>
                </div>

                <details>
                    <summary class="small muted">Notes</summary>
                    <div class="small muted" style="margin-top: 8px">
                        - If a legal split can’t be found, it’s usually because
                        one pool ends up with a count that can’t form valid team
                        sizes (like 1, 2, 5 for “only 4”, etc.).<br />
                        - With 12–16 people this runs instantly in the browser.
                    </div>
                </details>
            </div>

            <div class="card">
                <div class="row" style="margin-bottom: 10px">
                    <div class="small muted">Output</div>
                    <div
                        id="status"
                        class="small muted"
                        style="text-align: right"
                    ></div>
                </div>
                <div id="output" class="out"></div>
            </div>
        </div>

        <script>
            // ---------- storage ----------
            const STORAGE_KEY = "hanabi_randomizer_players_v2";
            /** player: { id: string, name: string, mode: "R0"|"H"|null }  (null => flex) */
            let players = [];

            function loadPlayers() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (!raw) return [];
                    const arr = JSON.parse(raw);
                    if (!Array.isArray(arr)) return [];
                    return arr
                        .filter((p) => p && typeof p.name === "string")
                        .map((p) => ({
                            id: p.id || crypto.randomUUID(),
                            name: p.name.trim(),
                            mode:
                                p.mode === "R0" || p.mode === "H"
                                    ? p.mode
                                    : null,
                        }))
                        .filter((p) => p.name.length);
                } catch {
                    return [];
                }
            }
            function savePlayers() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
            }

            // ---------- RNG ----------
            function hashToUint32(str) {
                let h = 2166136261 >>> 0;
                for (let i = 0; i < str.length; i++) {
                    h ^= str.charCodeAt(i);
                    h = Math.imul(h, 16777619);
                }
                return h >>> 0;
            }
            function mulberry32(seed) {
                return function () {
                    let t = (seed += 0x6d2b79f5) >>> 0;
                    t = Math.imul(t ^ (t >>> 15), t | 1);
                    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
                };
            }
            function shuffle(arr, rand) {
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(rand() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }

            // ---------- team sizes ----------
            function teamSizesFor(n, mode) {
                if (mode === "3")
                    return n % 3 === 0 ? Array(n / 3).fill(3) : null;
                if (mode === "4")
                    return n % 4 === 0 ? Array(n / 4).fill(4) : null;

                // 3/4 combo: 3a + 4b = n
                let best = null;
                for (let b = 0; 4 * b <= n; b++) {
                    const rem = n - 4 * b;
                    if (rem % 3 !== 0) continue;
                    const a = rem / 3;
                    const teams = a + b;
                    const score = teams * 1000 + b;
                    if (!best || score > best.score) best = { a, b, score };
                }
                if (!best) return null;
                const sizes = [];
                for (let i = 0; i < best.b; i++) sizes.push(4);
                for (let i = 0; i < best.a; i++) sizes.push(3);
                return sizes;
            }

            function sliceIntoTeams(names, sizes) {
                const teams = [];
                let idx = 0;
                for (const sz of sizes) {
                    teams.push(names.slice(idx, idx + sz));
                    idx += sz;
                }
                return teams;
            }

            // ---------- solver ----------
            function generateTeams({
                r0Only,
                hOnly,
                flex,
                mode,
                seedStr,
                tryLimit,
            }) {
                const seed = seedStr ? hashToUint32(seedStr) : Date.now() >>> 0;
                const rand = mulberry32(seed);

                let best = null;

                for (let t = 0; t < tryLimit; t++) {
                    const rPool = r0Only.slice();
                    const hPool = hOnly.slice();

                    for (const name of flex)
                        (rand() < 0.5 ? rPool : hPool).push(name);

                    const rSizes = teamSizesFor(rPool.length, mode);
                    const hSizes = teamSizesFor(hPool.length, mode);
                    if (!rSizes || !hSizes) continue;

                    const imbalance = Math.abs(rPool.length - hPool.length);
                    const score =
                        100000 -
                        imbalance * 100 +
                        (rSizes.length + hSizes.length);
                    if (!best || score > best.score) {
                        best = { rPool, hPool, rSizes, hSizes, score, seed };
                        if (imbalance === 0) break;
                    }
                }

                if (!best) {
                    return {
                        ok: false,
                        seed,
                        message:
                            `No legal split found within ${tryLimit} tries.\n` +
                            `Usually this means one pool ends up with a player count that can’t form valid teams.\n` +
                            `Try changing team mode, or making one more person flex, or adjusting player count.`,
                    };
                }

                const rand2 = mulberry32(best.seed ^ 0x9e3779b9);
                shuffle(best.rPool, rand2);
                shuffle(best.hPool, rand2);
                shuffle(best.rSizes, rand2);
                shuffle(best.hSizes, rand2);

                const rTeams = sliceIntoTeams(best.rPool, best.rSizes);
                const hTeams = sliceIntoTeams(best.hPool, best.hSizes);

                return {
                    ok: true,
                    seed: best.seed,
                    rTeams,
                    hTeams,
                    rCount: best.rPool.length,
                    hCount: best.hPool.length,
                };
            }

            // ---------- UI ----------
            const $nameInput = document.getElementById("nameInput");
            const $r0OnlyToggle = document.getElementById("r0OnlyToggle");
            const $hOnlyToggle = document.getElementById("hOnlyToggle");
            const $teamMode = document.getElementById("teamMode");
            const $seed = document.getElementById("seed");
            const $tries = document.getElementById("tries");
            const $list = document.getElementById("list");
            const $hint = document.getElementById("hint");
            const $output = document.getElementById("output");
            const $status = document.getElementById("status");

            function setStatus(text, kind) {
                $status.textContent = text;
                $status.className =
                    "small " +
                    (kind === "err" ? "err" : kind === "ok" ? "ok" : "muted");
            }

            function normalizeName(name) {
                return name.trim().replace(/\s+/g, " ");
            }

            // prevent both toggles on
            $r0OnlyToggle.addEventListener("change", () => {
                if ($r0OnlyToggle.checked) $hOnlyToggle.checked = false;
            });
            $hOnlyToggle.addEventListener("change", () => {
                if ($hOnlyToggle.checked) $r0OnlyToggle.checked = false;
            });

            function renderList() {
                $list.innerHTML = "";
                const total = players.length;
                const r0 = players.filter((p) => p.mode === "R0").length;
                const h = players.filter((p) => p.mode === "H").length;
                const flex = total - r0 - h;

                $hint.textContent = total
                    ? `Players: ${total} (R0-only: ${r0}, H-only: ${h}, flex: ${flex}) — saved in this browser`
                    : `No players yet. Add some above. (Saved locally in your browser.)`;

                for (const p of players) {
                    const row = document.createElement("div");
                    row.className = "player";

                    const name = document.createElement("div");
                    name.className = "name";
                    name.textContent = p.name;

                    const tag = document.createElement("div");
                    tag.className = "tag " + (p.mode ? "" : "flex");
                    tag.textContent =
                        p.mode === "R0"
                            ? "R0-only"
                            : p.mode === "H"
                              ? "H-only"
                              : "flex";

                    const toggle = document.createElement("button");
                    toggle.className = "btn-sm";
                    toggle.textContent = "Cycle";
                    toggle.title = "flex → R0-only → H-only → flex";
                    toggle.addEventListener("click", () => {
                        p.mode =
                            p.mode === null
                                ? "R0"
                                : p.mode === "R0"
                                  ? "H"
                                  : null;
                        savePlayers();
                        renderList();
                    });

                    const del = document.createElement("button");
                    del.className = "btn-sm btn-danger";
                    del.textContent = "Remove";
                    del.addEventListener("click", () => {
                        players = players.filter((x) => x.id !== p.id);
                        savePlayers();
                        renderList();
                    });

                    row.appendChild(name);
                    row.appendChild(tag);
                    row.appendChild(toggle);
                    row.appendChild(del);
                    $list.appendChild(row);
                }
            }

            function addPlayerFromForm() {
                const name = normalizeName($nameInput.value);
                if (!name) return;

                // de-dupe by case-insensitive name
                const exists = players.some(
                    (p) => p.name.toLowerCase() === name.toLowerCase(),
                );
                if (exists) {
                    setStatus("Name already exists", "err");
                    return;
                }

                let mode = null;
                if ($r0OnlyToggle.checked) mode = "R0";
                if ($hOnlyToggle.checked) mode = "H"; // (mutually exclusive already)

                players.push({ id: crypto.randomUUID(), name, mode });
                savePlayers();
                renderList();

                $nameInput.value = "";
                $r0OnlyToggle.checked = false;
                $hOnlyToggle.checked = false;
                $nameInput.focus();
                setStatus("Added", "ok");
                setTimeout(() => setStatus("", ""), 800);
            }

            document
                .getElementById("addBtn")
                .addEventListener("click", addPlayerFromForm);
            $nameInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") addPlayerFromForm();
            });

            document
                .getElementById("clearBtn")
                .addEventListener("click", () => {
                    if (!players.length) return;
                    const ok = confirm("Clear all players?");
                    if (!ok) return;
                    players = [];
                    savePlayers();
                    renderList();
                    $output.textContent = "";
                    setStatus("", "");
                });

            document.getElementById("run").addEventListener("click", () => {
                if (players.length < 3) {
                    setStatus("Need players", "err");
                    $output.textContent = "Add at least 3 players.";
                    return;
                }

                const r0Only = players
                    .filter((p) => p.mode === "R0")
                    .map((p) => p.name);
                const hOnly = players
                    .filter((p) => p.mode === "H")
                    .map((p) => p.name);
                const flex = players
                    .filter((p) => p.mode === null)
                    .map((p) => p.name);

                const seedStr = $seed.value.trim();
                const res = generateTeams({
                    r0Only,
                    hOnly,
                    flex,
                    mode: $teamMode.value,
                    seedStr,
                    tryLimit: Number($tries.value),
                });

                if (!res.ok) {
                    setStatus("No solution", "err");
                    $output.textContent = `❌ ${res.message}\n\nSeed used: ${seedStr ? seedStr : res.seed}`;
                    return;
                }

                setStatus("Generated", "ok");
                const seedLabel = seedStr ? seedStr : res.seed;

                let txt = "";
                txt += `Seed: ${seedLabel}\n\n`;
                txt += `R0 pool (${res.rCount})\n`;
                res.rTeams.forEach(
                    (t, i) => (txt += `  R${i + 1}: ${t.join(", ")}\n`),
                );
                txt += `\nH pool (${res.hCount})\n`;
                res.hTeams.forEach(
                    (t, i) => (txt += `  H${i + 1}: ${t.join(", ")}\n`),
                );

                $output.textContent = txt.trimEnd();
            });

            document
                .getElementById("copy")
                .addEventListener("click", async () => {
                    const text = $output.textContent || "";
                    if (!text.trim()) return;
                    try {
                        await navigator.clipboard.writeText(text);
                        setStatus("Copied", "ok");
                        setTimeout(() => setStatus("", ""), 1200);
                    } catch {
                        setStatus("Copy failed (browser blocked)", "err");
                    }
                });

            // init
            players = loadPlayers();
            renderList();
            setStatus("", "");
        </script>
    </body>
</html>
